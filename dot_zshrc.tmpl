# ============================================================================
# ~/.zshrc - Zsh Configuration
# ============================================================================

# bob nvim version manager (must come before other nvim paths)
export PATH="$HOME/.local/share/bob/nvim-bin:$HOME/.local/bin:$PATH"

{{ if eq .chezmoi.os "linux" -}}
# Add common Linux install locations to PATH
export PATH="$HOME/.fzf/bin:$HOME/bin:$PATH"
# Set locale for proper Unicode/icon support
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
{{ end -}}

# ============================================================================
# PROMPT CONFIGURATION - oh-my-posh
# ============================================================================
# Cross-platform prompt theme engine
# Using 'spaceship' theme (config in ~/.config/oh-my-posh/spaceship.omp.json)
if command -v oh-my-posh >/dev/null 2>&1; then
  if [[ -f "$HOME/.config/oh-my-posh/spaceship.omp.json" ]]; then
    eval "$(oh-my-posh init zsh --config "$HOME/.config/oh-my-posh/spaceship.omp.json")"
  else
    eval "$(oh-my-posh init zsh)"
  fi
fi

# ============================================================================
# ENVIRONMENT MANAGER - direnv
# ============================================================================
# Automatically load/unload environment variables based on .envrc files
if command -v direnv >/dev/null 2>&1; then
  eval "$(direnv hook zsh)"
fi

# ============================================================================
# PYTHON VERSION MANAGER - pyenv
# ============================================================================
export PYENV_ROOT="$HOME/.pyenv"
if [ -d "$PYENV_ROOT" ]; then
  export PATH="$PYENV_ROOT/bin:$PATH"
  eval "$(pyenv init --path)"
  eval "$(pyenv init -)"
fi

# ============================================================================
# NODE VERSION MANAGER - fnm
# ============================================================================
{{ if eq .chezmoi.os "linux" -}}
# fnm is installed to ~/.local/share/fnm on Linux
export PATH="$HOME/.local/share/fnm:$PATH"
{{ end -}}
if command -v fnm >/dev/null 2>&1; then
  eval "$(fnm env --use-on-cd --shell zsh)"
fi

# ============================================================================
# HISTORY CONFIGURATION
# ============================================================================
HISTFILE="$HOME/.zsh_history"
HISTSIZE=100000
SAVEHIST=100000

setopt APPEND_HISTORY        # append, don't overwrite
setopt INC_APPEND_HISTORY    # write history immediately
setopt SHARE_HISTORY         # share history between sessions
setopt HIST_IGNORE_ALL_DUPS  # remove older duplicates
setopt HIST_IGNORE_SPACE     # commands starting with space are not saved
setopt HIST_REDUCE_BLANKS    # strip extra blanks

# ============================================================================
# FUZZY FINDER - fzf
# ============================================================================

# fzf keybindings & completion
{{ if eq .chezmoi.os "darwin" -}}
if command -v brew >/dev/null 2>&1; then
  FZF_PREFIX="$(brew --prefix 2>/dev/null)/opt/fzf"
  if [[ -f "$FZF_PREFIX/shell/key-bindings.zsh" ]]; then
    source "$FZF_PREFIX/shell/key-bindings.zsh"
  fi
  if [[ -f "$FZF_PREFIX/shell/completion.zsh" ]]; then
    source "$FZF_PREFIX/shell/completion.zsh"
  fi
fi
{{ else if eq .chezmoi.os "linux" -}}
# fzf keybindings - try multiple locations
if [[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]]; then
  source /usr/share/doc/fzf/examples/key-bindings.zsh
elif [[ -f ~/.fzf/shell/key-bindings.zsh ]]; then
  source ~/.fzf/shell/key-bindings.zsh
elif command -v fzf >/dev/null 2>&1; then
  # Fallback: try fzf --zsh (newer versions)
  eval "$(fzf --zsh 2>/dev/null)" || true
fi
{{ end -}}

# FZF defaults
export FZF_DEFAULT_OPTS="
  --height 100%
  --layout=reverse
  --border
  --info=inline
  --color=prompt:6,marker:2,spinner:5
  --preview='echo {}'
"

# Use fd instead of find for file search (faster, respects .gitignore)
{{ if eq .chezmoi.os "linux" -}}
if command -v fdfind >/dev/null 2>&1; then
  export FZF_DEFAULT_COMMAND='fdfind --type f --hidden --follow --exclude .git'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
fi
{{ else -}}
if command -v fd >/dev/null 2>&1; then
  export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
fi
{{ end -}}

# Enhanced history search with bat preview (if bat present)
{{ if eq .chezmoi.os "linux" -}}
if command -v batcat >/dev/null 2>&1; then
  export FZF_CTRL_R_OPTS="
    --preview 'echo {} | batcat --style=numbers,plain --language=sh --color=always'
    --preview-window=up:5:wrap
    --bind 'ctrl-/:toggle-preview'
    --color header:italic
    --tiebreak=begin,index --no-sort --exact --algo=v2
  "
fi
{{ else -}}
if command -v bat >/dev/null 2>&1; then
  export FZF_CTRL_R_OPTS="
    --preview 'echo {} | bat --style=numbers,plain --language=sh --color=always'
    --preview-window=up:5:wrap
    --bind 'ctrl-/:toggle-preview'
    --color header:italic
    --tiebreak=begin,index --no-sort --exact --algo=v2
  "
fi
{{ end -}}

# ============================================================================
# ALIASES - Modern CLI Tool Replacements
# ============================================================================
alias ssh="ssh -F $HOME/.ssh/config"

{{ if eq .chezmoi.os "linux" -}}
# Debian/Ubuntu use different binary names to avoid conflicts
if command -v batcat >/dev/null 2>&1; then
  alias bat="batcat"
  alias cat="batcat"
fi

if command -v fdfind >/dev/null 2>&1; then
  alias fd="fdfind"
  alias find="fdfind"
fi
{{ else -}}
if command -v bat >/dev/null 2>&1; then
  alias cat="bat"
fi

if command -v fd >/dev/null 2>&1; then
  alias find="fd"
fi
{{ end -}}

if command -v eza >/dev/null 2>&1; then
  alias ls="eza --icons=always"
fi

if command -v nvim >/dev/null 2>&1; then
  alias vim="nvim"
fi

# ============================================================================
# ZSH ENHANCEMENTS
# ============================================================================
{{ if eq .chezmoi.os "darwin" -}}
# Syntax highlighting (Homebrew)
if [[ -f /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
  source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi

# Auto-suggestions (Homebrew)
if [[ -f /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
  source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
fi
{{ else if eq .chezmoi.os "linux" -}}
# Syntax highlighting (apt)
if [[ -f /usr/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
  source /usr/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi

# Auto-suggestions (apt)
if [[ -f /usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
  source /usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh
fi
{{ end -}}

# ============================================================================
# COMPLETION SYSTEM
# ============================================================================
{{ if eq .chezmoi.os "darwin" -}}
# Load completions from Homebrew (macOS)
if command -v brew >/dev/null 2>&1; then
  BREW_PREFIX="$(brew --prefix 2>/dev/null)"
  if [[ -d "$BREW_PREFIX/share/zsh-completions" ]]; then
    fpath=("$BREW_PREFIX/share/zsh-completions" $fpath)
  fi
fi
{{ end -}}

# Docker completions
if [[ -d "$HOME/.docker/completions" ]]; then
  fpath=("$HOME/.docker/completions" $fpath)
fi

autoload -Uz compinit
compinit -u

# ============================================================================
# SMART DIRECTORY NAVIGATION - zoxide
# ============================================================================
if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"
fi

# ============================================================================
# TMUX
# ============================================================================

# Generic: tmux session by name
tm() {
  local name="${1:-main}"
  tmux new-session -A -s "$name"
}

# Remote tmux: rmt host [session]
rmt() {
  local host="$1"
  local name="${2:-main}"
  ssh "$host" -t "tmux new-session -A -s $name"
}


